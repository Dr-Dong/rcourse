---
title: "Module 5 Exercise - Part A"
output: 
  pdf_document:
    df_print: kable
    highlight: zenburn
urlcolor: blue

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(include = TRUE)

```

```{r, message=FALSE, warning=FALSE}
# Initialize libraries
library(tidyverse)
library(rio)
library(plm)
library(broom)
library(stargazer)
library(lmtest)
library(ggthemes)
```

## 1. Preliminaries

a. Create a new RMarkdown PDF document in a *module5* folder of your course 
repository.
    
    - Be sure to commit and push changes to your course repository after each 
    question at a minimum (so after Q1, Q2, Q3).
    - Set the following output options:
    
        + Data frames should be printed using *kable*.
        + Code should be highlighted using the *zenburn* theme.

b. Initialize the Ecdat library

    - For the first part of the exercise, you will be working with the 
    [Ecdat](https://www.rdocumentation.org/packages/Ecdat/) 
    package, which has many economics datasets.  Hence you will need to install 
    and initialize the package.

```{r, message=FALSE}
library(Ecdat)
```

## 2. Educational outcomes using the Project STAR dataset 

### a. Create the dataset 

For the first part of the exercise, you will be working with data from Project 
STAR, an educational experiment conducted in Tennesse that examine the effect 
of student-teacher ratio on outcomes.  The experiment randomized students
into three class types: (1) a "regular" class size with 22-25 students, (2) a 
small class size with 13-17 students, and (3) a regular class size where the 
teacher was assisted by a teacher's aide.

a. Create an "star_data" data frame from the 
"[Star](https://rdrr.io/cran/Ecdat/man/Star.html#heading-0)" data in 
Ecdat as follows:

    ```{r, include=TRUE}
    star_data <- Star 
    ```

b. Turn the data set into a tibble
c. Select all variables except for "treadssk" to keep.
d. Rename the variables as follows:
    
    + Change "tmathssk" to "math_score"
    + Change "classk" to "class_type"
    + Change "totexpk" to "teacher_exper"
    + Change "totexpk" to "teacher_exper"
    + Change "freelunk" to "free_lunch"
    + Change "schidkn" to "school"
    
e. Create the following new variables:

    + "log_math_score", equal to the log of "math_score"
    + "teacher_exper_sq", equal to the square of "teacher_exper"

```{r}
star_data <- star_data %>% as_tibble() %>%
  select(-treadssk) %>%
  rename(math_score = tmathssk, class_type = classk,
         teacher_exper = totexpk, free_lunch = freelunk,
         school = schidkn) %>%
  mutate(log_math_score = log(math_score),
         teacher_exper_sq = teacher_exper^2)
```


f. Convert the school variable to a factor.

```{r}
star_data$school <- as.factor(star_data$school)
```


## 2. Perform regression 

a. Create a regression object that regresses *logged math scores* on 
$teacher \ experience$, $experience^2$, $class \ type$, $sex$, $race$, 
$free \ lunch \ status$, and fixed 
effects for each $school$.

    + First, use the *teacher_exper_sq* and *log_math_score* variables in the 
    regression
    + Then rewrite the regression to appropriately express the log and squared 
    variables using only *math_score* and *teacher_exper* in the regression.

```{r}
star_lm_prew <- lm(log_math_score ~ class_type + teacher_exper + 
                     I(teacher_exper^2) + sex + race + free_lunch + 
                     as.factor(school), data = star_data)

star_lm <- lm(log(math_score) ~ class_type + teacher_exper + 
                I(teacher_exper^2) + sex + race + free_lunch + 
                as.factor(school), data = star_data)
```

b. Display the summary output of the regression.
```{r}
summary(star_lm) 
```

c. Use **coeftest** to produce a regression summary with HC1 robust standard 
errors, saving this to *star_reg_robust* (do not display it).
```{r}
star_reg_robust <- coeftest(star_lm, vcov = vcovHC(star_lm, type="HC1"))
```

d. Display the *star_reg_robust* regression output with **stargazer**, setting 
the following options:
    + **omit="school"** to omit the school fixed effects.
    + **type="latex"** to produce Latex-type output.
    + **header=FALSE** to hide the autogenerated Header description.
    +  **float=FALSE** (a Latex option to ensure the tables stays in the position
    it was placed).
    + You will also probably need to add the option **results="asis"** to your code 
    chunk so that the Latex output from stargazer will render in the Rmarkdown 
    document.
    
    ```{r, results='asis'}
    stargazer(star_reg_robust, header=FALSE, type="latex", omit="school", 
                float = FALSE)
    ```  
    
e. Display the regression table wit HC1 robust standard errors using the 
**tidy** function.

    + Pipe the tidy regression output to the following **stringr** expression in 
    to remove the school fixed effects from the output. 
        ```{r, eval = FALSE, include=TRUE}
        filter(!str_detect(term, "(school)"))
        ```
    
        ```{r}
        tidy_star_reg_rob <- tidy(star_reg_robust) %>% 
            filter(!str_detect(term, "(school)"))
        tidy_star_reg_rob  
        ```
    + Bonus (ie not required): Replace the variable names in "term" with names 
    of your own.
    ```{r}
    tidy_star_reg_rob$term <-  recode(tidy_star_reg_rob$term,
        "(Intercept)" = "Intercept",
        "teacher_exper" = "Teacher experience",
        "I(teacher_exper^2)" = "Teacher experience^2^",
        "class_typesmall.class" = "Small class size",
        "class_typeregular.with.aide" = "Regular class w/ teacher aide",
        "sexboy" = "Male",
        "raceblack" = "Black",
        "raceother" = "Other race",
        "free_lunchyes" = "Student on freelunch"
      )
    tidy_star_reg_rob
    ```


## 3. Perform model diagnostics

Write the statistical decision from each test in your RMarkdown report:

a. Test for heteroskestacity.
    ```{r}
    bptest(star_lm)
    ```

b. Test for missing polynomial terms.
    ```{r}
    resettest(star_lm)
    ```

## 4. Visualize the relationship between math scores and class type with a box plot.

a. Re-rerun the regression above, but omit *class_type* from the regressors.
    ```{r}
    star_lm <- lm(log_math_score ~ teacher_exper + I(teacher_exper^2)  + sex +
              race + free_lunch + as.factor(school), data = star_data)
    ```

b. Create a tibble with *class_type* and the residuals from (a).
    ```{r}
    star_adj <- tibble(residuals(star_lm), star_data$class_type)
    ```

c. Appropriately rename the columns of the tibble.
    
    ```{r}
    colnames(star_adj) <- c("resid_math_score", "class_type")
    ```

d. Create a bar plot from the tibble, displaying the average residual math score 
by class type

    - Since we are not interested in a count of values for our bar plots, but 
    instead the average values for the residual math score, use the following options 
    inside of *geom_bar*: stat = "summary", fun.y = "mean".

    - Adding a graph title, axis labels, and style it like a Stata graph using
    **theme_stata()** from the
    [ggthemes](https://cran.r-project.org/web/packages/ggthemes/vignettes/ggthemes.html) 
    package.
    

    ```{r}
    ggplot(star_adj, aes(x=class_type, y=resid_math_score)) +
      geom_bar(stat = "summary", fun.y = "mean") +
      ggtitle("Residualized Log Math Score by Class Type") + 
      xlab("Class Type") + ylab("Residualized Math Score") + 
      theme_stata()
    ```
